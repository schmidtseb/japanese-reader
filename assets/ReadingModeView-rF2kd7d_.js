import{r as s,j as e,u as ae,a as re,c as le,V as ie}from"./index.prod-ijU6oP2D.js";import{u as oe,A as ce,a as ue}from"./AnalysisPlaceholder-B7Hh1mqk.js";import{a as de,b as xe}from"./gemini-DtAYdYzC.js";import{E as J}from"./PitchAccentVisualizer-B782rMJi.js";const fe=({entry:i,onExit:l,onSentenceChange:o,totalSentences:f,isVisible:g,onKeepVisible:m})=>{const y=i.readingProgress,[j,w]=s.useState(String(y+1));s.useEffect(()=>{w(String(y+1))},[y]);const S=()=>{let r=parseInt(j,10);if(isNaN(r)){w(String(y+1));return}r<1&&(r=1),r>f&&(r=f),o(r-1),w(String(r))},a=r=>{const N=r.target.value.replace(/[^0-9]/g,"");w(N)},v=r=>{r.key==="Enter"&&(S(),r.currentTarget.blur())};return e.jsx("header",{className:`fixed top-0 left-1/2 -translate-x-1/2 w-full max-w-4xl z-30 bg-surface/90 backdrop-blur-md shadow-sm rounded-b-lg transition-transform duration-250 ease-in-out ${g?"translate-y-0":"-translate-y-full"}`,onMouseEnter:()=>m(!0),onMouseLeave:()=>m(!1),children:e.jsx("div",{className:"p-2",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("button",{onClick:l,title:"Exit Reading Mode",className:"p-2 rounded-full hover:bg-surface-hover transition-colors",children:e.jsx("i",{className:"bi bi-box-arrow-right text-2xl text-text-secondary"})}),e.jsxs("div",{className:"font-medium text-text-secondary flex items-center gap-1",children:[e.jsx("input",{type:"text",inputMode:"numeric",pattern:"[0-9]*",value:j,onChange:a,onFocus:()=>m(!0),onBlur:()=>{S(),m(!1)},onKeyDown:v,title:"Enter sentence number and press Enter",className:"w-12 text-center bg-surface-subtle rounded-md p-1 focus:ring-2 focus:ring-focus-ring focus:outline-none [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"}),e.jsxs("span",{children:["/ ",f]})]})]})})})},me=({isVisible:i,onNav:l,sentenceIndex:o,totalSentences:f})=>e.jsx("div",{className:`fixed top-3/4 -translate-y-1/2 left-0 right-0 z-20 pointer-events-none transition-all duration-300 ${i?"opacity-100":"opacity-0"}`,children:e.jsxs("div",{className:"w-full max-w-4xl mx-auto relative h-0",children:[e.jsx("button",{id:"reading-nav-prev",onClick:()=>l("prev"),disabled:o===0,"aria-label":"Previous sentence",className:`absolute top-0 left-2 md:left-auto md:right-full md:mr-4 w-12 h-12 bg-surface/50 backdrop-blur-sm text-text-primary rounded-full shadow-lg flex items-center justify-center text-2xl transition-all duration-300 hover:bg-surface/80 disabled:opacity-20 disabled:cursor-not-allowed pointer-events-auto ${i?"scale-100":"scale-90"}`,children:"←"}),e.jsx("button",{id:"reading-nav-next",onClick:()=>l("next"),disabled:o>=f-1,"aria-label":"Next sentence",className:`absolute top-0 right-2 md:right-auto md:left-full md:ml-4 w-12 h-12 bg-surface/50 backdrop-blur-sm text-text-primary rounded-full shadow-lg flex items-center justify-center text-2xl transition-all duration-300 hover:bg-surface/80 disabled:opacity-20 disabled:cursor-not-allowed pointer-events-auto ${i?"scale-100":"scale-90"}`,children:"→"})]})}),he=({quizData:i,onClose:l})=>{const[o,f]=s.useState(0),[g,m]=s.useState(null),[y,j]=s.useState(0),[w,S]=s.useState(!1),a=i.questions[o],v=u=>{g===null&&(m(u),u===a.correct_answer_index&&j(x=>x+1))},r=()=>{o<i.questions.length-1?(f(u=>u+1),m(null)):S(!0)},I=()=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-sm font-semibold text-text-muted mb-2",children:["Question ",o+1," of ",i.questions.length]}),e.jsx("p",{className:"text-xl font-medium text-text-primary mb-6 text-center",children:a.question}),e.jsx("div",{className:"w-full space-y-3",children:a.options.map((u,x)=>{let C="w-full text-left p-4 rounded-lg border-2 transition-colors duration-200 disabled:cursor-not-allowed";return g!==null?x===a.correct_answer_index?C+=" bg-accent-subtle-bg border-accent text-accent-text":x===g?C+=" bg-destructive-subtle-bg border-destructive text-destructive-subtle-text":C+=" bg-surface border-border-subtle opacity-60":C+=" bg-surface border-border hover:bg-surface-hover hover:border-primary",e.jsxs("button",{onClick:()=>v(x),disabled:g!==null,className:C,children:[e.jsxs("span",{className:"font-bold mr-3",children:[String.fromCharCode(65+x),"."]}),u]},x)})}),g!==null&&e.jsxs("div",{className:"mt-6 w-full animate-fade-in space-y-4",children:[e.jsxs("div",{className:"p-4 bg-surface-soft rounded-lg",children:[e.jsx("h4",{className:"font-bold text-accent-text mb-1",children:"Explanation"}),e.jsx("p",{className:"text-sm text-text-secondary",children:a.explanation})]}),e.jsx("button",{onClick:r,className:"btn-primary w-full text-lg",children:o<i.questions.length-1?"Next":"Finish Quiz"})]})]}),N=()=>e.jsxs("div",{className:"text-center flex flex-col items-center justify-center h-full",children:[e.jsx("i",{className:"bi bi-award text-6xl text-accent mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-text-primary",children:"Quiz Complete!"}),e.jsxs("p",{className:"text-4xl font-bold my-4",children:["You scored ",e.jsx("span",{className:"text-primary",children:y})," out of ",i.questions.length]}),e.jsx("button",{onClick:l,className:"btn-secondary mt-6",children:"Back to Reading"})]});return e.jsx("div",{className:"fixed inset-0 bg-background/90 backdrop-blur-md z-50 flex items-center justify-center p-4 animate-fade-in",onClick:l,children:e.jsxs("div",{className:"relative w-full max-w-2xl bg-surface rounded-2xl shadow-2xl flex flex-col max-h-[90vh]",onClick:u=>u.stopPropagation(),children:[e.jsxs("header",{className:"flex-shrink-0 p-4 md:p-6 border-b border-border-subtle text-center relative",children:[e.jsx("button",{onClick:l,className:"btn-ghost absolute top-2 right-2 md:top-4 md:right-4",title:"Close Quiz",children:e.jsx("i",{className:"bi bi-x-lg text-2xl"})}),e.jsxs("div",{className:"text-xs font-semibold uppercase tracking-wider px-2 py-1 bg-primary-subtle-bg text-primary-subtle-text rounded-full inline-block",children:["Text Difficulty: ",i.estimated_jlpt_level]})]}),e.jsx("main",{className:"flex-grow overflow-y-auto no-scrollbar p-6 md:p-8",children:w?N():I()})]})})},ye=()=>{const{state:i,dispatch:l}=ae(),{state:o}=re(),{dispatch:f}=le(),[g,m]=s.useState(!1),[y,j]=s.useState(!0),[w,S]=s.useState(""),a=s.useRef(null),v=s.useRef(null),r=s.useRef({x:0,y:0,time:0}),I=s.useRef(null),N=s.useRef(null),[u,x]=s.useState(null),[C,z]=s.useState(!1),{isLoading:Q,error:O,data:A,execute:U,reset:_}=de(),n=i.history.find(t=>t.id===i.currentTextEntryId),M=s.useMemo(()=>(n==null?void 0:n.text.split(`
`).filter(t=>t.trim()))||[],[n==null?void 0:n.text]),T=s.useMemo(()=>M.map(t=>{var c;return((c=t.match(/[^。？！]+(?:[。？！][」』]*)?/g))==null?void 0:c.filter(d=>d==null?void 0:d.trim()))||[]}),[M]),p=s.useMemo(()=>T.flat(),[T]),b=(n==null?void 0:n.readingProgress)??0,E=p[b],R=p[b+1],{analysis:Y,isLoading:K,error:F,reanalyze:B}=oe(n==null?void 0:n.id,E),{execute:X}=xe(),L=()=>{u&&(N.current=E,U(u))};s.useEffect(()=>{A&&E===N.current&&(z(!0),x(null))},[A,E]);const Z=()=>{z(!1),_(),N.current=null},q=s.useCallback(()=>{m(!0),a.current&&window.clearTimeout(a.current),a.current=window.setTimeout(()=>{m(!1)},4e3)},[]),ee=s.useCallback(t=>{a.current&&(window.clearTimeout(a.current),a.current=null),t||(a.current=window.setTimeout(()=>{m(!1)},2500))},[]),h=s.useCallback(()=>{j(!0),v.current&&window.clearTimeout(v.current),v.current=window.setTimeout(()=>{j(!1)},1500)},[]),$=s.useCallback(t=>{const c=t==="prev"&&b>0,d=t==="next"&&b<p.length-1;(c||d)&&(S(t==="next"?"animate-page-flip-next":"animate-page-flip-prev"),l({type:"NAVIGATE_SENTENCE",payload:{direction:t}}),navigator.vibrate&&navigator.vibrate(10),h())},[l,b,p.length,h]),te=s.useCallback(t=>{l({type:"JUMP_TO_SENTENCE",payload:{index:t}})},[l]);s.useEffect(()=>{if(!n||p.length===0)return;x(null);let t=-1,c=0;for(let k=0;k<T.length;k++)if(c+=T[k].length,b<c){t=k;break}if(t===-1&&p.length>0)t=T.length-1;else if(t===-1)return;const d=T[t],P=c-d.length,D=b-P===d.length-1;b===p.length-1?x(n.text):D&&x(M[t])},[b,p,M,T,n]),s.useEffect(()=>{f({type:"HIDE_BOTTOM_SHEET"}),f({type:"HIDE_TOOLTIP"}),h(),_(),z(!1),N.current=null},[E,f,h,_]),s.useEffect(()=>{h();const t=I.current;return t&&t.addEventListener("scroll",h,{passive:!0}),()=>{a.current&&window.clearTimeout(a.current),v.current&&window.clearTimeout(v.current),t&&t.removeEventListener("scroll",h)}},[h]);const se=t=>{h();const c=t.touches[0];r.current={x:c.clientX,y:c.clientY,time:Date.now()}},ne=t=>{const c=t.changedTouches[0],{x:d,y:P,time:G}=r.current,{clientX:D,clientY:W}=c,k=Date.now()-G,V=D-d,H=W-P;if(P<50&&H>30&&Math.abs(V)<30){q();return}if(k<500&&Math.abs(V)>50&&Math.abs(H)<50){$(V>0?"prev":"next");return}if(k<250&&Math.abs(V)<10&&Math.abs(H)<10){h();return}};return s.useEffect(()=>{var t;n&&R&&((t=n.analyzedSentences[R])!=null&&t[o.analysisDepth]||X(R,o.analysisDepth).then(d=>{d&&n&&l({type:"CACHE_ANALYSIS",payload:{entryId:n.id,sentence:R,depth:o.analysisDepth,analysis:d}})}))},[R,n,o.analysisDepth,X,l]),n?e.jsxs("div",{className:"reading-mode-view h-screen flex flex-col bg-surface",onTouchStart:se,onTouchEnd:ne,onClick:h,children:[e.jsx("div",{className:"fixed top-0 left-0 right-0 h-5 z-40",onClick:q}),e.jsx(fe,{entry:n,onExit:()=>l({type:"SET_VIEW",payload:ie.Reader}),onSentenceChange:te,totalSentences:p.length,isVisible:g,onKeepVisible:ee}),e.jsx(me,{isVisible:y,onNav:$,sentenceIndex:b,totalSentences:p.length}),e.jsx("main",{className:"flex-1 flex flex-col min-h-0",children:e.jsx("div",{ref:I,className:"flex-1 overflow-y-auto min-h-0 no-scrollbar",style:{perspective:"1500px"},children:e.jsx("div",{className:w,onAnimationEnd:()=>S(""),children:E?F?e.jsx(J,{error:F,onRetry:B}):Y?e.jsx(ce,{analysis:Y,onReanalyze:B,availableQuizText:u,onStartQuiz:L,isQuizLoading:Q}):e.jsx(ue,{sentence:E,isLoading:K}):e.jsxs("div",{className:"text-center p-8 text-text-muted flex flex-col items-center justify-center h-full",children:[e.jsx("h2",{className:"text-2xl font-bold text-text-primary mb-4",children:"End of Text"}),e.jsx("p",{className:"mb-6",children:"You've finished reading. Ready to test your knowledge?"}),e.jsx("button",{onClick:L,className:"btn-primary",disabled:Q||!u,children:Q?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"bi bi-arrow-repeat animate-spin mr-2"})," Generating Quiz..."]}):"Test My Comprehension"}),O&&e.jsx(J,{error:O,onRetry:L})]})})})}),C&&A&&e.jsx(he,{quizData:A,onClose:Z})]}):e.jsx("div",{children:"Error: No text selected."})};export{ye as ReadingModeView};
