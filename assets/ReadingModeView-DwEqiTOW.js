import{r as a,j as n,u as O,a as X,c as F,V as $}from"./index.prod-wyqjZk6G.js";import{u as B,E as J,A as U,a as G}from"./AnalysisPlaceholder-D2Hv3U1E.js";import{u as W}from"./gemini-8rvYl3Nn.js";import"./PitchAccentVisualizer-BfOCVX0-.js";const q=({entry:d,onExit:r,onSentenceChange:c,totalSentences:u,isVisible:j,onKeepVisible:f})=>{const m=d.readingProgress,[g,s]=a.useState(String(m+1));a.useEffect(()=>{s(String(m+1))},[m]);const x=()=>{let e=parseInt(g,10);if(isNaN(e)){s(String(m+1));return}e<1&&(e=1),e>u&&(e=u),c(e-1),s(String(e))},v=e=>{const h=e.target.value.replace(/[^0-9]/g,"");s(h)},y=e=>{e.key==="Enter"&&(x(),e.currentTarget.blur())};return n.jsx("header",{className:`fixed top-0 left-1/2 -translate-x-1/2 w-full max-w-4xl z-30 bg-surface/90 backdrop-blur-md shadow-sm rounded-b-lg transition-transform duration-250 ease-in-out ${j?"translate-y-0":"-translate-y-full"}`,onMouseEnter:()=>f(!0),onMouseLeave:()=>f(!1),children:n.jsx("div",{className:"p-2",children:n.jsxs("div",{className:"flex justify-between items-center",children:[n.jsx("button",{onClick:r,title:"Exit Reading Mode",className:"p-2 rounded-full hover:bg-surface-hover transition-colors",children:n.jsx("i",{className:"bi bi-box-arrow-right text-2xl text-text-secondary"})}),n.jsxs("div",{className:"font-medium text-text-secondary flex items-center gap-1",children:[n.jsx("input",{type:"text",inputMode:"numeric",pattern:"[0-9]*",value:g,onChange:v,onFocus:()=>f(!0),onBlur:()=>{x(),f(!1)},onKeyDown:y,title:"Enter sentence number and press Enter",className:"w-12 text-center bg-surface-subtle rounded-md p-1 focus:ring-2 focus:ring-focus-ring focus:outline-none [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"}),n.jsxs("span",{children:["/ ",u]})]})]})})})},K=({isVisible:d,onNav:r,sentenceIndex:c,totalSentences:u})=>n.jsx("div",{className:`fixed top-3/4 -translate-y-1/2 left-0 right-0 z-20 pointer-events-none transition-all duration-300 ${d?"opacity-100":"opacity-0"}`,children:n.jsxs("div",{className:"w-full max-w-4xl mx-auto relative h-0",children:[n.jsx("button",{id:"reading-nav-prev",onClick:()=>r("prev"),disabled:c===0,"aria-label":"Previous sentence",className:`absolute top-0 left-2 md:left-auto md:right-full md:mr-4 w-12 h-12 bg-surface/50 backdrop-blur-sm text-text-primary rounded-full shadow-lg flex items-center justify-center text-2xl transition-all duration-300 hover:bg-surface/80 disabled:opacity-20 disabled:cursor-not-allowed pointer-events-auto ${d?"scale-100":"scale-90"}`,children:"←"}),n.jsx("button",{id:"reading-nav-next",onClick:()=>r("next"),disabled:c>=u-1,"aria-label":"Next sentence",className:`absolute top-0 right-2 md:right-auto md:left-full md:ml-4 w-12 h-12 bg-surface/50 backdrop-blur-sm text-text-primary rounded-full shadow-lg flex items-center justify-center text-2xl transition-all duration-300 hover:bg-surface/80 disabled:opacity-20 disabled:cursor-not-allowed pointer-events-auto ${d?"scale-100":"scale-90"}`,children:"→"})]})}),ne=()=>{const{state:d,dispatch:r}=O(),{state:c}=X(),{dispatch:u}=F(),[j,f]=a.useState(!1),[m,g]=a.useState(!0),s=a.useRef(null),x=a.useRef(null),v=a.useRef({x:0,y:0,time:0}),y=a.useRef(null),e=d.history.find(t=>t.id===d.currentTextEntryId),p=a.useMemo(()=>(e==null?void 0:e.text.split(`
`).flatMap(t=>{var o;return((o=t.match(/[^。？！]+(?:[。？！][」』]*)?/g))==null?void 0:o.filter(l=>l==null?void 0:l.trim()))||[]}))||[],[e==null?void 0:e.text]),h=(e==null?void 0:e.readingProgress)??0,w=p[h],b=p[h+1],{analysis:T,isLoading:V,error:S,reanalyze:C}=B(e==null?void 0:e.id,w),{execute:k}=W(),I=a.useCallback(()=>{f(!0),s.current&&window.clearTimeout(s.current),s.current=window.setTimeout(()=>{f(!1)},4e3)},[]),A=a.useCallback(t=>{s.current&&(window.clearTimeout(s.current),s.current=null),t||(s.current=window.setTimeout(()=>{f(!1)},2500))},[]),i=a.useCallback(()=>{g(!0),x.current&&window.clearTimeout(x.current),x.current=window.setTimeout(()=>{g(!1)},1500)},[]),D=a.useCallback(t=>{const o=t==="prev"&&h>0,l=t==="next"&&h<p.length-1;(o||l)&&(r({type:"NAVIGATE_SENTENCE",payload:{direction:t}}),navigator.vibrate&&navigator.vibrate(10),i())},[r,h,p.length,i]),H=a.useCallback(t=>{r({type:"JUMP_TO_SENTENCE",payload:{index:t}})},[r]);a.useEffect(()=>{u({type:"HIDE_BOTTOM_SHEET"}),u({type:"HIDE_TOOLTIP"}),i()},[w,u,i]),a.useEffect(()=>{i();const t=y.current;return t&&t.addEventListener("scroll",i,{passive:!0}),()=>{s.current&&window.clearTimeout(s.current),x.current&&window.clearTimeout(x.current),t&&t.removeEventListener("scroll",i)}},[i]);const _=t=>{i();const o=t.touches[0];v.current={x:o.clientX,y:o.clientY,time:Date.now()}},z=t=>{const o=t.changedTouches[0],{x:l,y:M,time:P}=v.current,{clientX:L,clientY:Y}=o,R=Date.now()-P,N=L-l,E=Y-M;if(M<50&&E>30&&Math.abs(N)<30){I();return}if(R<500&&Math.abs(N)>50&&Math.abs(E)<50){D(N>0?"prev":"next");return}if(R<250&&Math.abs(N)<10&&Math.abs(E)<10){i();return}};return a.useEffect(()=>{var t;e&&b&&((t=e.analyzedSentences[b])!=null&&t[c.analysisDepth]||k(b,c.analysisDepth).then(l=>{l&&e&&r({type:"CACHE_ANALYSIS",payload:{entryId:e.id,sentence:b,depth:c.analysisDepth,analysis:l}})}))},[b,e,c.analysisDepth,k,r]),e?n.jsxs("div",{className:"reading-mode-view h-screen flex flex-col bg-surface",onTouchStart:_,onTouchEnd:z,onClick:i,children:[n.jsx("div",{className:"fixed top-0 left-0 right-0 h-5 z-40",onClick:I}),n.jsx(q,{entry:e,onExit:()=>r({type:"SET_VIEW",payload:$.Reader}),onSentenceChange:H,totalSentences:p.length,isVisible:j,onKeepVisible:A}),n.jsx(K,{isVisible:m,onNav:D,sentenceIndex:h,totalSentences:p.length}),n.jsx("main",{className:"flex-1 flex flex-col min-h-0",children:n.jsx("div",{ref:y,className:"flex-1 overflow-y-auto min-h-0 no-scrollbar",children:w?S?n.jsx(J,{error:S,onRetry:C}):T?n.jsx(U,{analysis:T,onReanalyze:C}):n.jsx(G,{sentence:w,isLoading:V}):n.jsx("div",{className:"text-center p-8 text-text-muted",children:"End of text."})})})]}):n.jsx("div",{children:"Error: No text selected."})};export{ne as default};
