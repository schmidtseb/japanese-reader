import{r as a,j as e,u as L,a as O,c as X,V as $}from"./index.prod-Dcqqmj7B.js";import{u as B,E as F,A as J,a as K}from"./AnalysisPlaceholder-DiTQQr01.js";import{u as U}from"./gemini-Beq2aEEu.js";import"./PitchAccentVisualizer-CYmosM0i.js";const G=({entry:u,onExit:i,onSentenceChange:d,totalSentences:o,isVisible:N})=>{const h=u.readingProgress,[v,p]=a.useState(String(h+1));a.useEffect(()=>{p(String(h+1))},[h]);const f=()=>{let s=parseInt(v,10);(isNaN(s)||s<1)&&(s=1),s>o&&(s=o),d(s-1),p(String(s))},x=s=>{s.key==="Enter"&&(f(),s.currentTarget.blur())};return e.jsx("header",{className:`fixed top-0 left-1/2 -translate-x-1/2 w-full max-w-4xl z-30 bg-surface/90 backdrop-blur-md shadow-sm rounded-b-lg transition-transform duration-250 ease-in-out ${N?"translate-y-0":"-translate-y-full"}`,children:e.jsx("div",{className:"p-2",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("button",{onClick:i,title:"Exit Reading Mode",className:"p-2 rounded-full hover:bg-surface-hover transition-colors",children:e.jsx("i",{className:"bi bi-box-arrow-right text-2xl text-text-secondary"})}),e.jsxs("div",{className:"font-medium text-text-secondary flex items-center gap-1",children:[e.jsx("input",{type:"number",value:v,onChange:s=>p(s.target.value),onBlur:f,onKeyDown:x,min:"1",max:o,title:"Enter sentence number and press Enter",className:"w-12 text-center bg-surface-subtle rounded-md p-1 focus:ring-2 focus:ring-focus-ring focus:outline-none [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"}),e.jsxs("span",{children:["/ ",o]})]})]})})})},W=({isVisible:u,onNav:i,sentenceIndex:d,totalSentences:o})=>e.jsx("div",{className:`fixed top-3/4 -translate-y-1/2 left-0 right-0 z-20 pointer-events-none transition-all duration-300 ${u?"opacity-100":"opacity-0"}`,children:e.jsxs("div",{className:"w-full max-w-4xl mx-auto relative h-0",children:[e.jsx("button",{id:"reading-nav-prev",onClick:()=>i("prev"),disabled:d===0,"aria-label":"Previous sentence",className:`absolute top-0 left-2 md:left-auto md:right-full md:mr-4 w-12 h-12 bg-surface/50 backdrop-blur-sm text-text-primary rounded-full shadow-lg flex items-center justify-center text-2xl transition-all duration-300 hover:bg-surface/80 disabled:opacity-20 disabled:cursor-not-allowed pointer-events-auto ${u?"scale-100":"scale-90"}`,children:"←"}),e.jsx("button",{id:"reading-nav-next",onClick:()=>i("next"),disabled:d>=o-1,"aria-label":"Next sentence",className:`absolute top-0 right-2 md:right-auto md:left-full md:ml-4 w-12 h-12 bg-surface/50 backdrop-blur-sm text-text-primary rounded-full shadow-lg flex items-center justify-center text-2xl transition-all duration-300 hover:bg-surface/80 disabled:opacity-20 disabled:cursor-not-allowed pointer-events-auto ${u?"scale-100":"scale-90"}`,children:"→"})]})}),te=()=>{const{state:u,dispatch:i}=L(),{state:d}=O(),{dispatch:o}=X(),[N,h]=a.useState(!1),[v,p]=a.useState(!0),f=a.useRef(null),x=a.useRef(null),s=a.useRef({x:0,y:0,time:0}),E=a.useRef(null),n=u.history.find(t=>t.id===u.currentTextEntryId),m=a.useMemo(()=>(n==null?void 0:n.text.split(`
`).flatMap(t=>{var l;return((l=t.match(/[^。？！]+(?:[。？！][」』]*)?/g))==null?void 0:l.filter(c=>c==null?void 0:c.trim()))||[]}))||[],[n==null?void 0:n.text]),b=(n==null?void 0:n.readingProgress)??0,y=m[b],g=m[b+1],{analysis:T,isLoading:V,error:S,reanalyze:C}=B(n==null?void 0:n.id,y),{execute:k}=U(),D=a.useCallback(()=>{h(!0),f.current&&window.clearTimeout(f.current),f.current=window.setTimeout(()=>{h(!1)},4e3)},[]),r=a.useCallback(()=>{p(!0),x.current&&window.clearTimeout(x.current),x.current=window.setTimeout(()=>{p(!1)},1500)},[]),I=a.useCallback(t=>{const l=t==="prev"&&b>0,c=t==="next"&&b<m.length-1;(l||c)&&(i({type:"NAVIGATE_SENTENCE",payload:{direction:t}}),navigator.vibrate&&navigator.vibrate(10),r())},[i,b,m.length,r]),A=a.useCallback(t=>{i({type:"JUMP_TO_SENTENCE",payload:{index:t}})},[i]);a.useEffect(()=>{o({type:"HIDE_BOTTOM_SHEET"}),o({type:"HIDE_TOOLTIP"}),r()},[y,o,r]),a.useEffect(()=>{r();const t=E.current;return t&&t.addEventListener("scroll",r,{passive:!0}),()=>{f.current&&window.clearTimeout(f.current),x.current&&window.clearTimeout(x.current),t&&t.removeEventListener("scroll",r)}},[r]);const H=t=>{r();const l=t.touches[0];s.current={x:l.clientX,y:l.clientY,time:Date.now()}},_=t=>{const l=t.changedTouches[0],{x:c,y:R,time:z}=s.current,{clientX:P,clientY:Y}=l,M=Date.now()-z,w=P-c,j=Y-R;if(R<50&&j>30&&Math.abs(w)<30){D();return}if(M<500&&Math.abs(w)>50&&Math.abs(j)<50){I(w>0?"prev":"next");return}if(M<250&&Math.abs(w)<10&&Math.abs(j)<10){r();return}};return a.useEffect(()=>{var t;n&&g&&((t=n.analyzedSentences[g])!=null&&t[d.analysisDepth]||k(g,d.analysisDepth).then(c=>{c&&n&&i({type:"CACHE_ANALYSIS",payload:{entryId:n.id,sentence:g,depth:d.analysisDepth,analysis:c}})}))},[g,n,d.analysisDepth,k,i]),n?e.jsxs("div",{className:"reading-mode-view h-screen flex flex-col bg-surface",onTouchStart:H,onTouchEnd:_,onClick:r,children:[e.jsx("div",{className:"fixed top-0 left-0 right-0 h-5 z-40",onClick:D}),e.jsx(G,{entry:n,onExit:()=>i({type:"SET_VIEW",payload:$.Reader}),onSentenceChange:A,totalSentences:m.length,isVisible:N}),e.jsx(W,{isVisible:v,onNav:I,sentenceIndex:b,totalSentences:m.length}),e.jsx("main",{className:"flex-1 flex flex-col min-h-0",children:e.jsx("div",{ref:E,className:"flex-1 overflow-y-auto min-h-0 no-scrollbar",children:y?S?e.jsx(F,{error:S,onRetry:C}):T?e.jsx(J,{analysis:T,onReanalyze:C}):e.jsx(K,{sentence:y,isLoading:V}):e.jsx("div",{className:"text-center p-8 text-text-muted",children:"End of text."})})})]}):e.jsx("div",{children:"Error: No text selected."})};export{te as default};
