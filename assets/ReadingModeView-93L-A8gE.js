import{r as s,j as e,u as te,a as se,c as ne,V as ae}from"./index.prod-D7g2wUrF.js";import{u as re,A as le,a as ie}from"./AnalysisPlaceholder-B6q78rYp.js";import{a as oe,b as ce}from"./gemini-Dnbr_uT3.js";import{E as G}from"./PitchAccentVisualizer-EDPc28iu.js";const ue=({entry:i,onExit:r,onSentenceChange:o,totalSentences:x,isVisible:y,onKeepVisible:f})=>{const w=i.readingProgress,[j,l]=s.useState(String(w+1));s.useEffect(()=>{l(String(w+1))},[w]);const p=()=>{let a=parseInt(j,10);if(isNaN(a)){l(String(w+1));return}a<1&&(a=1),a>x&&(a=x),o(a-1),l(String(a))},b=a=>{const k=a.target.value.replace(/[^0-9]/g,"");l(k)},E=a=>{a.key==="Enter"&&(p(),a.currentTarget.blur())};return e.jsx("header",{className:`fixed top-0 left-1/2 -translate-x-1/2 w-full max-w-4xl z-30 bg-surface/90 backdrop-blur-md shadow-sm rounded-b-lg transition-transform duration-250 ease-in-out ${y?"translate-y-0":"-translate-y-full"}`,onMouseEnter:()=>f(!0),onMouseLeave:()=>f(!1),children:e.jsx("div",{className:"p-2",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("button",{onClick:r,title:"Exit Reading Mode",className:"p-2 rounded-full hover:bg-surface-hover transition-colors",children:e.jsx("i",{className:"bi bi-box-arrow-right text-2xl text-text-secondary"})}),e.jsxs("div",{className:"font-medium text-text-secondary flex items-center gap-1",children:[e.jsx("input",{type:"text",inputMode:"numeric",pattern:"[0-9]*",value:j,onChange:b,onFocus:()=>f(!0),onBlur:()=>{p(),f(!1)},onKeyDown:E,title:"Enter sentence number and press Enter",className:"w-12 text-center bg-surface-subtle rounded-md p-1 focus:ring-2 focus:ring-focus-ring focus:outline-none [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"}),e.jsxs("span",{children:["/ ",x]})]})]})})})},de=({isVisible:i,onNav:r,sentenceIndex:o,totalSentences:x})=>e.jsx("div",{className:`fixed top-3/4 -translate-y-1/2 left-0 right-0 z-20 pointer-events-none transition-all duration-300 ${i?"opacity-100":"opacity-0"}`,children:e.jsxs("div",{className:"w-full max-w-4xl mx-auto relative h-0",children:[e.jsx("button",{id:"reading-nav-prev",onClick:()=>r("prev"),disabled:o===0,"aria-label":"Previous sentence",className:`absolute top-0 left-2 md:left-auto md:right-full md:mr-4 w-12 h-12 bg-surface/50 backdrop-blur-sm text-text-primary rounded-full shadow-lg flex items-center justify-center text-2xl transition-all duration-300 hover:bg-surface/80 disabled:opacity-20 disabled:cursor-not-allowed pointer-events-auto ${i?"scale-100":"scale-90"}`,children:"←"}),e.jsx("button",{id:"reading-nav-next",onClick:()=>r("next"),disabled:o>=x-1,"aria-label":"Next sentence",className:`absolute top-0 right-2 md:right-auto md:left-full md:ml-4 w-12 h-12 bg-surface/50 backdrop-blur-sm text-text-primary rounded-full shadow-lg flex items-center justify-center text-2xl transition-all duration-300 hover:bg-surface/80 disabled:opacity-20 disabled:cursor-not-allowed pointer-events-auto ${i?"scale-100":"scale-90"}`,children:"→"})]})}),xe=({quizData:i,onClose:r})=>{const[o,x]=s.useState(0),[y,f]=s.useState(null),[w,j]=s.useState(0),[l,p]=s.useState(!1),b=i.questions[o],E=d=>{y===null&&(f(d),d===b.correct_answer_index&&j(m=>m+1))},a=()=>{o<i.questions.length-1?(x(d=>d+1),f(null)):p(!0)},S=()=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-sm font-semibold text-text-muted mb-2",children:["Question ",o+1," of ",i.questions.length]}),e.jsx("p",{className:"text-xl font-medium text-text-primary mb-6 text-center",children:b.question}),e.jsx("div",{className:"w-full space-y-3",children:b.options.map((d,m)=>{let N="w-full text-left p-4 rounded-lg border-2 transition-colors duration-200 disabled:cursor-not-allowed";return y!==null?m===b.correct_answer_index?N+=" bg-accent-subtle-bg border-accent text-accent-text":m===y?N+=" bg-destructive-subtle-bg border-destructive text-destructive-subtle-text":N+=" bg-surface border-border-subtle opacity-60":N+=" bg-surface border-border hover:bg-surface-hover hover:border-primary",e.jsxs("button",{onClick:()=>E(m),disabled:y!==null,className:N,children:[e.jsxs("span",{className:"font-bold mr-3",children:[String.fromCharCode(65+m),"."]}),d]},m)})}),y!==null&&e.jsxs("div",{className:"mt-6 w-full animate-fade-in space-y-4",children:[e.jsxs("div",{className:"p-4 bg-surface-soft rounded-lg",children:[e.jsx("h4",{className:"font-bold text-accent-text mb-1",children:"Explanation"}),e.jsx("p",{className:"text-sm text-text-secondary",children:b.explanation})]}),e.jsx("button",{onClick:a,className:"btn-primary w-full text-lg",children:o<i.questions.length-1?"Next":"Finish Quiz"})]})]}),k=()=>e.jsxs("div",{className:"text-center flex flex-col items-center justify-center h-full",children:[e.jsx("i",{className:"bi bi-award text-6xl text-accent mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-text-primary",children:"Quiz Complete!"}),e.jsxs("p",{className:"text-4xl font-bold my-4",children:["You scored ",e.jsx("span",{className:"text-primary",children:w})," out of ",i.questions.length]}),e.jsx("button",{onClick:r,className:"btn-secondary mt-6",children:"Back to Reading"})]});return e.jsx("div",{className:"fixed inset-0 bg-background/90 backdrop-blur-md z-50 flex items-center justify-center p-4 animate-fade-in",onClick:r,children:e.jsxs("div",{className:"relative w-full max-w-2xl bg-surface rounded-2xl shadow-2xl flex flex-col max-h-[90vh]",onClick:d=>d.stopPropagation(),children:[e.jsxs("header",{className:"flex-shrink-0 p-4 md:p-6 border-b border-border-subtle text-center relative",children:[e.jsx("button",{onClick:r,className:"btn-ghost absolute top-2 right-2 md:top-4 md:right-4",title:"Close Quiz",children:e.jsx("i",{className:"bi bi-x-lg text-2xl"})}),e.jsxs("div",{className:"text-xs font-semibold uppercase tracking-wider px-2 py-1 bg-primary-subtle-bg text-primary-subtle-text rounded-full inline-block",children:["Text Difficulty: ",i.estimated_jlpt_level]})]}),e.jsx("main",{className:"flex-grow overflow-y-auto no-scrollbar p-6 md:p-8",children:l?k():S()})]})})},be=()=>{const{state:i,dispatch:r}=te(),{state:o}=se(),{dispatch:x}=ne(),[y,f]=s.useState(!1),[w,j]=s.useState(!0),l=s.useRef(null),p=s.useRef(null),b=s.useRef({x:0,y:0,time:0}),E=s.useRef(null),[a,S]=s.useState(null),[k,d]=s.useState(!1),{isLoading:m,error:N,data:I,execute:D,reset:P}=oe(),n=i.history.find(t=>t.id===i.currentTextEntryId),z=s.useMemo(()=>(n==null?void 0:n.text.split(`
`).filter(t=>t.trim()))||[],[n==null?void 0:n.text]),C=s.useMemo(()=>z.map(t=>{var c;return((c=t.match(/[^。？！]+(?:[。？！][」』]*)?/g))==null?void 0:c.filter(u=>u==null?void 0:u.trim()))||[]}),[z]),g=s.useMemo(()=>C.flat(),[C]),v=(n==null?void 0:n.readingProgress)??0,R=g[v],Q=g[v+1],{analysis:H,isLoading:W,error:O,reanalyze:Y}=re(n==null?void 0:n.id,R),{execute:F}=ce(),V=()=>{a&&D(a)};s.useEffect(()=>{I&&(d(!0),S(null))},[I]);const J=()=>{d(!1),P()},B=s.useCallback(()=>{f(!0),l.current&&window.clearTimeout(l.current),l.current=window.setTimeout(()=>{f(!1)},4e3)},[]),U=s.useCallback(t=>{l.current&&(window.clearTimeout(l.current),l.current=null),t||(l.current=window.setTimeout(()=>{f(!1)},2500))},[]),h=s.useCallback(()=>{j(!0),p.current&&window.clearTimeout(p.current),p.current=window.setTimeout(()=>{j(!1)},1500)},[]),X=s.useCallback(t=>{const c=t==="prev"&&v>0,u=t==="next"&&v<g.length-1;(c||u)&&(r({type:"NAVIGATE_SENTENCE",payload:{direction:t}}),navigator.vibrate&&navigator.vibrate(10),h())},[r,v,g.length,h]),K=s.useCallback(t=>{r({type:"JUMP_TO_SENTENCE",payload:{index:t}})},[r]);s.useEffect(()=>{if(!n||g.length===0)return;S(null);let t=-1,c=0;for(let T=0;T<C.length;T++)if(c+=C[T].length,v<c){t=T;break}if(t===-1&&g.length>0)t=C.length-1;else if(t===-1)return;const u=C[t],M=c-u.length,_=v-M===u.length-1;v===g.length-1?S(n.text):_&&S(z[t])},[v,g,z,C,n]),s.useEffect(()=>{x({type:"HIDE_BOTTOM_SHEET"}),x({type:"HIDE_TOOLTIP"}),h(),P(),d(!1)},[R,x,h,P]),s.useEffect(()=>{h();const t=E.current;return t&&t.addEventListener("scroll",h,{passive:!0}),()=>{l.current&&window.clearTimeout(l.current),p.current&&window.clearTimeout(p.current),t&&t.removeEventListener("scroll",h)}},[h]);const Z=t=>{h();const c=t.touches[0];b.current={x:c.clientX,y:c.clientY,time:Date.now()}},ee=t=>{const c=t.changedTouches[0],{x:u,y:M,time:$}=b.current,{clientX:_,clientY:q}=c,T=Date.now()-$,A=_-u,L=q-M;if(M<50&&L>30&&Math.abs(A)<30){B();return}if(T<500&&Math.abs(A)>50&&Math.abs(L)<50){X(A>0?"prev":"next");return}if(T<250&&Math.abs(A)<10&&Math.abs(L)<10){h();return}};return s.useEffect(()=>{var t;n&&Q&&((t=n.analyzedSentences[Q])!=null&&t[o.analysisDepth]||F(Q,o.analysisDepth).then(u=>{u&&n&&r({type:"CACHE_ANALYSIS",payload:{entryId:n.id,sentence:Q,depth:o.analysisDepth,analysis:u}})}))},[Q,n,o.analysisDepth,F,r]),n?e.jsxs("div",{className:"reading-mode-view h-screen flex flex-col bg-surface",onTouchStart:Z,onTouchEnd:ee,onClick:h,children:[e.jsx("div",{className:"fixed top-0 left-0 right-0 h-5 z-40",onClick:B}),e.jsx(ue,{entry:n,onExit:()=>r({type:"SET_VIEW",payload:ae.Reader}),onSentenceChange:K,totalSentences:g.length,isVisible:y,onKeepVisible:U}),e.jsx(de,{isVisible:w,onNav:X,sentenceIndex:v,totalSentences:g.length}),e.jsx("main",{className:"flex-1 flex flex-col min-h-0",children:e.jsx("div",{ref:E,className:"flex-1 overflow-y-auto min-h-0 no-scrollbar",children:R?O?e.jsx(G,{error:O,onRetry:Y}):H?e.jsx(le,{analysis:H,onReanalyze:Y,availableQuizText:a,onStartQuiz:V,isQuizLoading:m}):e.jsx(ie,{sentence:R,isLoading:W}):e.jsxs("div",{className:"text-center p-8 text-text-muted flex flex-col items-center justify-center h-full",children:[e.jsx("h2",{className:"text-2xl font-bold text-text-primary mb-4",children:"End of Text"}),e.jsx("p",{className:"mb-6",children:"You've finished reading. Ready to test your knowledge?"}),e.jsx("button",{onClick:V,className:"btn-primary",disabled:m||!a,children:m?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"bi bi-arrow-repeat animate-spin mr-2"})," Generating Quiz..."]}):"Test My Comprehension"}),N&&e.jsx(G,{error:N,onRetry:V})]})})}),k&&I&&e.jsx(xe,{quizData:I,onClose:J})]}):e.jsx("div",{children:"Error: No text selected."})};export{be as ReadingModeView};
