import{u as C,a as v,r as g,b as D,j as e,c as P,R as $}from"./index-BFr8dD8R.js";import{u as R,a as I}from"./gemini-B8_edHxO.js";import{P as M,F as N,T as L}from"./PitchAccentVisualizer-g-VtqlS_.js";const Y=(t,n)=>{const{state:l,dispatch:m}=C(),{state:u}=v(),{execute:c,error:x,isLoading:p}=R(),[s,r]=g.useState(null),a=g.useMemo(()=>t?l.history.find(o=>o.id===t):null,[t,l.history]),i=u.analysisDepth;g.useEffect(()=>{var f;let o=!1;if(!n){r(null);return}if((s==null?void 0:s.sentence)===n)return;const h=((f=a==null?void 0:a.analyzedSentences[n])==null?void 0:f[i])||null;if(h){r({sentence:n,analysis:h});return}return r(null),c(n,i).then(j=>{!o&&j&&r({sentence:n,analysis:j})}),()=>{o=!0}},[n,i,a,c,s==null?void 0:s.sentence]),g.useEffect(()=>{var o;s&&t&&((o=a==null?void 0:a.analyzedSentences[s.sentence])!=null&&o[i]||m({type:"CACHE_ANALYSIS",payload:{entryId:t,sentence:s.sentence,depth:i,analysis:s.analysis}}))},[s,t,i,a,m]);const b=g.useCallback(()=>{n&&(r(null),c(n,i,!0).then(o=>{o&&r({sentence:n,analysis:o})}))},[n,i,c]),d=(s==null?void 0:s.sentence)===n?s.analysis:null;return{analysis:d,isLoading:p||!!n&&!d&&!x,error:x,reanalyze:b}};function E({itemId:t,itemType:n,itemContent:l}){const{state:m,dispatch:u}=C(),{showAlert:c}=D(),x=!!m.reviewDeck.find(s=>s.id===t),p=s=>{s.stopPropagation();const{currentTextEntryId:r}=m;if(!r){c("Cannot add an item to the deck without first saving the text.");return}const a=x?"REMOVE_REVIEW_ITEM":"ADD_OR_UPDATE_REVIEW_ITEM";if(a==="REMOVE_REVIEW_ITEM")u({type:a,payload:t});else{const i={id:t,type:n,content:l,textEntryId:r,srsStage:0,intervalModifier:1,incorrectAnswerCount:0,nextReviewDate:new Date().setHours(0,0,0,0),addedAt:Date.now()};u({type:a,payload:i})}};return x?e.jsxs("button",{onClick:p,className:"in-deck-button text-xs font-semibold px-2 py-1 rounded-md border border-accent text-accent bg-accent-subtle-bg hover:bg-destructive-subtle-bg hover:text-destructive hover:border-destructive transition inline-flex items-center gap-2",title:"Remove from Review Deck",children:[e.jsx("i",{className:"bi bi-check-lg text-base"}),"In Deck"]}):e.jsxs("button",{onClick:p,className:"add-to-deck-button text-xs font-semibold px-2 py-1 rounded-md border border-primary-subtle-text text-primary-subtle-text hover:bg-primary-subtle-bg hover:text-primary-subtle-text/80 transition inline-flex items-center gap-2",title:"Add to Review Deck",children:[e.jsx("i",{className:"bi bi-plus-lg text-base"}),"Add to Deck"]})}function z(t){const n=(t||"unknown").split(/[-_]/)[0].toLowerCase(),l={noun:"bg-pos-noun-bg text-pos-noun-text",verb:"bg-pos-verb-bg text-pos-verb-text",particle:"bg-pos-particle-bg text-pos-particle-text",adjective:"bg-pos-adjective-bg text-pos-adjective-text",adverb:"bg-pos-adverb-bg text-pos-adverb-text",auxiliary:"bg-pos-auxiliary-bg text-pos-auxiliary-text",grammatical:"bg-pos-auxiliary-bg text-pos-auxiliary-text",conjunction:"bg-pos-conjunction-bg text-pos-conjunction-text",suffix:"bg-pos-suffix-bg text-pos-suffix-text",punctuation:"bg-transparent",unknown:"bg-surface-soft"};return l[n]||l.unknown}function w(t,n){const l=t*137.5%360;return n==="dark"?`hsl(${l}, 65%, 60%)`:`hsl(${l}, 70%, 45%)`}const H=({segment:t})=>e.jsxs("div",{children:[e.jsx("div",{className:"text-lg font-japanese font-semibold mb-3 pb-2 border-b border-border-subtle",children:e.jsx(N,{base:t.japanese_segment,reading:t.reading||"",interactiveKanji:!0})}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("p",{children:[e.jsx("strong",{className:"font-medium text-text-secondary",children:"Meaning:"})," ",t.english_equivalent]}),e.jsxs("p",{children:[e.jsx("strong",{className:"font-medium text-text-secondary",children:"Category:"})," ",e.jsx("span",{className:"capitalize",children:t.category.replace(/_/g," ").toLowerCase()})]}),e.jsxs("p",{children:[e.jsx("strong",{className:"font-medium text-text-secondary",children:"Reading:"})," ",t.reading]})]}),e.jsx("div",{className:"mt-4 pt-3 border-t border-border-subtle",children:e.jsx(E,{itemId:`word-${t.japanese_segment}-${t.reading}`,itemType:"word",itemContent:t})})]}),O=({segment:t})=>{const{state:n}=v(),{state:l,dispatch:m}=P(),{japanese_segment:u,reading:c,category:x,pitch_accent:p,patterns:s}=t,r=d=>{const o=d.currentTarget,h=e.jsx(H,{segment:t});if(window.innerWidth<768)l.bottomSheet.visible&&l.bottomSheet.targetElement===o?m({type:"HIDE_BOTTOM_SHEET"}):m({type:"SHOW_BOTTOM_SHEET",payload:{content:{title:u,body:h},targetElement:o}});else{const f=o.getBoundingClientRect(),j={top:f.top-10,left:f.left+f.width/2};m({type:"PIN_TOOLTIP",payload:{content:h,position:j,targetElement:o}})}},a=g.useMemo(()=>{if(!s||s.length===0)return{};const d=3,o=2,h=d+o,f=s.map(y=>`linear-gradient(to right, ${y.color}, ${y.color})`).join(", "),j=s.map((y,A)=>`0 calc(100% - ${A*h}px)`).join(", "),_=s.map(()=>`100% ${d}px`).join(", "),S=4,T=s.length*h-o;return{backgroundImage:f,backgroundPosition:j,backgroundSize:_,paddingBottom:`${S+T}px`}},[s]),i=["segment","relative","inline-block","rounded-md","px-2","cursor-pointer","transition-transform","duration-200","hover:-translate-y-0.5","leading-loose",n.showColorCoding?z(x):"bg-surface-soft",s&&s.length>0?"grammar-pattern":""].filter(Boolean).join(" "),b={paddingTop:n.showPitchAccent?"18px":"0.25rem",paddingBottom:"0.25rem",...a};return e.jsxs("span",{className:i,style:b,onClick:r,children:[e.jsx(M,{reading:c,pitchAccent:p}),e.jsx("div",{children:e.jsx(N,{base:u,reading:c})})]})};function B({pattern:t,onNoteClick:n,isFocused:l}){const{isLoading:m,error:u,data:c,execute:x}=I(),[p,s]=g.useState(!1),r=d=>{d.stopPropagation(),c?s(!p):(x(t.pattern_name),s(!0))},a=`grammar-${t.pattern_name}`,i=(t.constituent_indices||[]).map(d=>{const o=t.fullAnalysis.analysis[d];return o?o.japanese_segment:null}).filter(Boolean).join(""),b={pattern_name:t.pattern_name,explanation:t.explanation,original_sentence:t.fullAnalysis.original_japanese_sentence,constituent_text:i};return e.jsxs("li",{className:`flex gap-4 p-4 rounded-lg bg-surface-subtle cursor-pointer transition-all duration-200 ${l?"is-focused ring-2 ring-focus-ring bg-surface-soft":""}`,"data-pattern-id":t.idClass,onClick:()=>n(t),children:[e.jsx("span",{className:"flex-shrink-0 w-1.5 rounded-full",style:{backgroundColor:t.color}}),e.jsxs("div",{className:"flex-grow",children:[e.jsx("strong",{className:"font-semibold text-accent",children:t.pattern_name}),e.jsx("p",{className:"text-sm text-text-muted mt-1",children:t.explanation}),e.jsxs("div",{className:"mt-3 flex items-center gap-2 flex-wrap",children:[e.jsxs("button",{className:"show-examples-button text-xs font-semibold px-2 py-1 rounded-md border border-accent text-accent hover:bg-accent hover:text-primary-text transition inline-flex items-center gap-2 disabled:opacity-50",onClick:r,disabled:m,children:[m?e.jsx("i",{className:"bi bi-arrow-repeat text-base animate-spin"}):e.jsx("i",{className:"bi bi-card-list text-base"}),e.jsx("span",{className:"button-text",children:p&&c?"Hide":"Examples"})]}),e.jsx(E,{itemId:a,itemType:"grammar",itemContent:b})]}),p&&e.jsxs("div",{className:"examples-container mt-4 pt-4 border-t border-dashed border-border-subtle",children:[u&&e.jsx("p",{className:"text-xs text-destructive-subtle-text",children:u.message}),c&&e.jsx("dl",{className:"flex flex-col gap-4",children:c.map((d,o)=>e.jsxs($.Fragment,{children:[e.jsx("dt",{children:e.jsx("span",{className:"text-lg font-jp",children:e.jsx(N,{base:d.japanese,reading:d.reading})})}),e.jsx("dd",{className:"text-sm text-text-muted -mt-1",children:d.english})]},o))})]})]})]})}const F=()=>e.jsxs("div",{className:"mt-6 p-4 border-t border-border-subtle text-center",children:[e.jsx("h4",{className:"text-xs font-bold uppercase text-text-muted tracking-wider mb-3",children:"Hotkeys"}),e.jsxs("div",{className:"flex flex-wrap justify-center items-center gap-x-4 gap-y-2 text-xs text-text-secondary",children:[e.jsxs("span",{children:[e.jsx("kbd",{className:"font-sans font-semibold p-1 px-1.5 rounded bg-surface border border-border-subtle shadow-sm",children:"F"})," Furigana"]}),e.jsxs("span",{children:[e.jsx("kbd",{className:"font-sans font-semibold p-1 px-1.5 rounded bg-surface border border-border-subtle shadow-sm",children:"C"})," Colors"]}),e.jsxs("span",{children:[e.jsx("kbd",{className:"font-sans font-semibold p-1 px-1.5 rounded bg-surface border border-border-subtle shadow-sm",children:"T"})," Translate"]}),e.jsxs("span",{children:[e.jsx("kbd",{className:"font-sans font-semibold p-1 px-1.5 rounded bg-surface border border-border-subtle shadow-sm",children:"S"})," Speak"]}),e.jsx("div",{className:"w-px h-4 bg-border mx-2 self-center"}),e.jsxs("span",{children:[e.jsx("kbd",{className:"font-sans font-semibold p-1 px-1.5 rounded bg-surface border border-border-subtle shadow-sm",children:"J"}),"/",e.jsx("kbd",{className:"font-sans font-semibold p-1 px-1.5 rounded bg-surface border border-border-subtle shadow-sm",children:"K"})," Nav"]}),e.jsxs("span",{children:[e.jsx("kbd",{className:"font-sans font-semibold p-1 px-1.5 rounded bg-surface border border-border-subtle shadow-sm",children:"E"})," Examples"]}),e.jsxs("span",{children:[e.jsx("kbd",{className:"font-sans font-semibold p-1 px-1.5 rounded bg-surface border border-border-subtle shadow-sm",children:"Esc"})," Deselect"]})]})]});function q({analysis:t,onReanalyze:n}){const[l,m]=g.useState(null),[u,c]=g.useState(!1),{state:x}=v(),p=g.useMemo(()=>{if(!t.grammar_patterns)return t.analysis.map(a=>({...a,patterns:[]}));const r=new Map;return t.grammar_patterns.forEach((a,i)=>{var o;const b=w(i,x.theme),d=`pattern-dynamic-${i}`;(o=a.constituent_indices)==null||o.forEach(h=>{r.has(h)||r.set(h,[]),r.get(h).push({...a,idClass:d,color:b})})}),t.analysis.map((a,i)=>({...a,patterns:r.get(i)||[]}))},[t,x.theme]),s=r=>{m(a=>(a==null?void 0:a.idClass)===r.idClass?null:r)};return e.jsxs("div",{className:"analysis-view-container animate-fade-in max-w-4xl mx-auto w-full",children:[e.jsxs("div",{id:"analysis-header",className:"relative sticky top-0 z-20 bg-surface-soft rounded-lg transition-colors duration-300 p-4 min-h-36",children:[e.jsx("div",{className:"flex flex-wrap items-start gap-x-1.5 gap-y-1 text-2xl max-h-[50vh] overflow-y-auto no-scrollbar pr-8",children:p.map((r,a)=>e.jsx("div",{className:`transition-opacity duration-300 ${l&&!r.patterns.some(i=>i.idClass===l.idClass)?"opacity-30":"opacity-100"}`,children:e.jsx(O,{segment:r})},a))}),u&&e.jsx("div",{className:"translation-text-container mt-4 pt-4 border-t border-dashed border-border-subtle",children:e.jsx("p",{className:"text-text-primary text-base",children:t.english_translation})}),e.jsxs("div",{className:"absolute top-4 right-4 flex flex-col items-center gap-2",children:[e.jsx(L,{text:t.original_japanese_sentence,title:"Read sentence (S)"}),e.jsx("button",{onClick:n,title:"Force re-analysis",className:"btn-ghost p-1 text-text-muted hover:text-text-primary",children:e.jsx("i",{className:"bi bi-arrow-clockwise text-base"})}),e.jsx("button",{id:"toggle-translation-button",onClick:()=>c(r=>!r),title:"Toggle translation (T)",className:"btn-ghost p-1 text-text-muted hover:text-text-primary",children:e.jsx("i",{className:"bi bi-translate text-base"})})]})]}),e.jsx("div",{className:"p-4 space-y-4",children:t.grammar_patterns&&t.grammar_patterns.length>0&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold uppercase text-text-muted mb-3 tracking-wider",children:"Grammar & Phrases"}),e.jsx("ul",{className:"space-y-3",children:t.grammar_patterns.map((r,a)=>{const i=w(a,x.theme),b=`pattern-dynamic-${a}`,d={...r,idClass:b,color:i,fullAnalysis:t};return e.jsx(B,{pattern:d,onNoteClick:s,isFocused:(l==null?void 0:l.idClass)===b},a)})})]})}),e.jsx(F,{})]})}const k=5,U=({error:t,onRetry:n})=>{const[l,m]=g.useState(!1),[u,c]=g.useState(0),x=(t==null?void 0:t.message)||"An unknown error occurred.";g.useEffect(()=>{const a=/rate limit|429/i.test(x);if(m(a),a){c(k);const i=setInterval(()=>{c(b=>b<=1?(clearInterval(i),0):b-1)},1e3);return()=>clearInterval(i)}else c(0)},[x]);const p=()=>{n&&(l&&c(k),n())},s=l?"Too many requests":"API Error",r=l?"You are analyzing sentences too quickly. Please wait a moment before trying again.":x;return e.jsx("div",{role:"alert",className:"p-4 bg-destructive-subtle-bg border-l-4 border-destructive rounded-r-lg shadow-md my-4 transition-all duration-300",children:e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("i",{className:"bi bi-x-circle-fill text-xl text-destructive","aria-hidden":"true"})}),e.jsxs("div",{className:"ml-3 flex-1",children:[e.jsx("p",{className:"text-sm font-semibold text-destructive-subtle-text",children:s}),r&&e.jsx("div",{className:"mt-2 text-sm text-destructive-subtle-text/80",children:e.jsx("p",{children:r})}),n&&e.jsx("button",{onClick:p,disabled:u>0,className:"mt-3 text-xs font-semibold px-2 py-1 rounded-md border border-destructive-subtle-text text-destructive-subtle-text hover:bg-destructive-subtle-text/10 transition disabled:opacity-50 disabled:cursor-wait",children:u>0?`Try Again in ${u}s`:"Try Again"})]})]})})},K=({sentence:t,isLoading:n=!0})=>e.jsxs("div",{className:"relative p-4 bg-surface-soft rounded-lg min-h-36 animate-fade-in",children:[e.jsx("div",{className:"flex flex-wrap items-start gap-x-1.5 gap-y-1 text-2xl pr-8",children:e.jsx("p",{className:`text-2xl text-text-muted font-japanese transition-opacity duration-500 ${n?"opacity-50":"opacity-100"}`,children:t})}),n&&e.jsx("div",{className:"absolute top-4 right-4 flex items-center gap-2",children:e.jsx("i",{className:"bi bi-arrow-repeat text-lg text-text-muted animate-spin",role:"status","aria-label":"Loading analysis"})})]});export{q as A,U as E,K as a,Y as u};
