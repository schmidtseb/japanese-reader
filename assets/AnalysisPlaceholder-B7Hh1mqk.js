import{u as C,a as w,r as g,b as D,j as e,c as T,R as P}from"./index.prod-ijU6oP2D.js";import{b as R,c as B,d as $}from"./gemini-DtAYdYzC.js";import{E as I,F as N,P as M,T as z}from"./PitchAccentVisualizer-B782rMJi.js";const J=(t,a)=>{const{state:r,dispatch:c}=C(),{state:x}=w(),{execute:l,error:p,isLoading:b}=R(),[s,d]=g.useState(null),m=g.useMemo(()=>t?r.history.find(i=>i.id===t):null,[t,r.history]),u=x.analysisDepth;g.useEffect(()=>{var f;let i=!1;if(!a){d(null);return}if((s==null?void 0:s.sentence)===a)return;const h=((f=m==null?void 0:m.analyzedSentences[a])==null?void 0:f[u])||null;if(h){d({sentence:a,analysis:h});return}return d(null),l(a,u).then(j=>{!i&&j&&d({sentence:a,analysis:j})}),()=>{i=!0}},[a,u,m,l]),g.useEffect(()=>{var i;s&&t&&((i=m==null?void 0:m.analyzedSentences[s.sentence])!=null&&i[u]||c({type:"CACHE_ANALYSIS",payload:{entryId:t,sentence:s.sentence,depth:u,analysis:s.analysis}}))},[s,t,u,m,c]);const o=g.useCallback(()=>{a&&(d(null),l(a,u,!0).then(i=>{i&&d({sentence:a,analysis:i})}))},[a,u,l]),n=(s==null?void 0:s.sentence)===a?s.analysis:null;return{analysis:n,isLoading:b||!!a&&!n&&!p,error:p,reanalyze:o}};function _({itemType:t,itemContent:a}){const{state:r,dispatch:c}=C(),{showAlert:x}=D(),l=g.useMemo(()=>{if(t==="word")return r.reviewDeck.find(s=>s.type==="word"&&s.content.japanese_segment===a.japanese_segment&&s.content.reading===a.reading);if(t==="grammar")return r.reviewDeck.find(s=>s.type==="grammar"&&s.content.pattern_name===a.pattern_name)},[r.reviewDeck,t,a]),p=!!l,b=s=>{s.stopPropagation();const{currentTextEntryId:d}=r;if(!d){x("Cannot add an item to the deck without first saving the text.");return}if(p)c({type:"REMOVE_REVIEW_ITEM",payload:l.id});else{const m={id:crypto.randomUUID(),type:t,content:a,textEntryId:d,srsStage:0,intervalModifier:1,incorrectAnswerCount:0,nextReviewDate:new Date().setHours(0,0,0,0),addedAt:Date.now()};c({type:"ADD_OR_UPDATE_REVIEW_ITEM",payload:m})}};return p?e.jsxs("button",{onClick:b,className:"in-deck-button text-xs font-semibold px-2 py-1 rounded-md border border-accent text-accent bg-accent-subtle-bg hover:bg-destructive-subtle-bg hover:text-destructive hover:border-destructive transition inline-flex items-center gap-2",title:"Remove from Review Deck",children:[e.jsx("i",{className:"bi bi-check-lg text-base"}),"In Deck"]}):e.jsxs("button",{onClick:b,className:"add-to-deck-button text-xs font-semibold px-2 py-1 rounded-md border border-primary-subtle-text text-primary-subtle-text hover:bg-primary-subtle-bg hover:text-primary-subtle-text/80 transition inline-flex items-center gap-2",title:"Add to Review Deck",children:[e.jsx("i",{className:"bi bi-plus-lg text-base"}),"Add to Deck"]})}function H(t){const a=(t||"unknown").split(/[-_]/)[0].toLowerCase(),r={noun:"bg-pos-noun-bg text-pos-noun-text",verb:"bg-pos-verb-bg text-pos-verb-text",particle:"bg-pos-particle-bg text-pos-particle-text",adjective:"bg-pos-adjective-bg text-pos-adjective-text",adverb:"bg-pos-adverb-bg text-pos-adverb-text",auxiliary:"bg-pos-auxiliary-bg text-pos-auxiliary-text",grammatical:"bg-pos-auxiliary-bg text-pos-auxiliary-text",conjunction:"bg-pos-conjunction-bg text-pos-conjunction-text",suffix:"bg-pos-suffix-bg text-pos-suffix-text",punctuation:"bg-transparent",unknown:"bg-surface-soft"};return r[a]||r.unknown}function k(t,a){const r=t*137.5%360;return a==="dark"?`hsl(${r}, 65%, 60%)`:`hsl(${r}, 70%, 45%)`}const O=({word:t,reading:a,onBack:r})=>{const{data:c,isLoading:x,error:l,execute:p}=B();g.useEffect(()=>{p(t,a)},[t,a,p]);const b=()=>{p(t,a)};return x&&!c?e.jsx("div",{className:"flex items-center justify-center p-8 min-h-[200px]",children:e.jsx("i",{className:"bi bi-arrow-repeat text-3xl text-text-muted animate-spin"})}):l?e.jsxs("div",{className:"p-2",children:[e.jsx("div",{className:"flex justify-end",children:e.jsxs("button",{onClick:r,className:"btn-ghost",title:"Back to quick info",children:[e.jsx("i",{className:"bi bi-arrow-left"})," Back"]})}),e.jsx(I,{error:l,onRetry:b})]}):c?e.jsxs("div",{className:"p-2 space-y-4 animate-fade-in",children:[e.jsxs("div",{className:"flex justify-between items-center pb-2 border-b border-border-subtle",children:[e.jsx("h4",{className:"text-lg font-semibold font-japanese",children:c.word}),e.jsxs("button",{onClick:r,className:"btn-ghost",title:"Back to quick info",children:[e.jsx("i",{className:"bi bi-arrow-left"})," Back"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold text-text-secondary text-sm",children:"Definition"}),e.jsx("p",{className:"text-text-primary",children:c.definition}),e.jsx("p",{className:"text-xs text-text-muted mt-1",children:c.part_of_speech})]}),e.jsxs("div",{children:[e.jsx("h5",{className:"font-semibold text-text-secondary mb-2 text-sm",children:"Example Sentences"}),e.jsx("ul",{className:"space-y-4",children:c.example_sentences.map((s,d)=>e.jsxs("li",{className:"flex flex-col",children:[e.jsx("a",{href:`https://jisho.org/search/${encodeURIComponent(s.japanese)}`,target:"_blank",rel:"noopener noreferrer",className:"text-base font-jp text-text-primary hover:text-accent transition",onClick:m=>m.stopPropagation(),children:e.jsx(N,{base:s.japanese,reading:s.reading})}),e.jsx("span",{className:"text-sm text-text-muted",children:s.english})]},d))})]})]})]}):e.jsxs("div",{className:"p-4 text-center text-text-muted",children:[e.jsx("div",{className:"flex justify-end",children:e.jsxs("button",{onClick:r,className:"btn-ghost",title:"Back to quick info",children:[e.jsx("i",{className:"bi bi-arrow-left"})," Back"]})}),e.jsx("p",{children:"No details found for this word."})]})},W=({segment:t})=>{const[a,r]=g.useState("info"),c=t.category.split(/[-_]/)[0],x=["NOUN","VERB","ADJECTIVE","ADVERB"].includes(c);return a==="analysis"?e.jsx(O,{word:t.japanese_segment,reading:t.reading,onBack:()=>r("info")}):e.jsxs("div",{children:[e.jsx("div",{className:"text-lg font-japanese font-semibold mb-3 pb-2 border-b border-border-subtle",children:e.jsx(N,{base:t.japanese_segment,reading:t.reading||"",interactiveKanji:!0})}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("p",{children:[e.jsx("strong",{className:"font-medium text-text-secondary",children:"Meaning:"})," ",t.english_equivalent]}),e.jsxs("p",{children:[e.jsx("strong",{className:"font-medium text-text-secondary",children:"Category:"})," ",e.jsx("span",{className:"capitalize",children:t.category.replace(/_/g," ").toLowerCase()})]}),e.jsxs("p",{children:[e.jsx("strong",{className:"font-medium text-text-secondary",children:"Reading:"})," ",t.reading]})]}),e.jsxs("div",{className:"mt-4 pt-3 border-t border-border-subtle flex justify-between items-center gap-2",children:[e.jsx(_,{itemType:"word",itemContent:t}),x&&e.jsx("button",{onClick:()=>r("analysis"),className:"text-xs font-semibold px-2 py-1 rounded-md border border-accent text-accent hover:bg-accent-subtle-bg transition",title:"Get detailed analysis and examples for this word",children:"Analyze Word"})]})]})},F=({segment:t})=>{const{state:a}=w(),{state:r,dispatch:c}=T(),{japanese_segment:x,reading:l,category:p,pitch_accent:b,patterns:s}=t,d=n=>{const i=n.currentTarget,h=e.jsx(W,{segment:t});if(window.innerWidth<768)r.bottomSheet.visible&&r.bottomSheet.targetElement===i?c({type:"HIDE_BOTTOM_SHEET"}):c({type:"SHOW_BOTTOM_SHEET",payload:{content:{title:x,body:h},targetElement:i}});else{const f=i.getBoundingClientRect(),j={top:f.top-10,left:f.left+f.width/2};c({type:"PIN_TOOLTIP",payload:{content:h,position:j,targetElement:i}})}},m=g.useMemo(()=>{if(!s||s.length===0)return{};const n=3,i=2,h=n+i,f=s.map(v=>`linear-gradient(to right, ${v.color}, ${v.color})`).join(", "),j=s.map((v,A)=>`0 calc(100% - ${A*h}px)`).join(", "),y=s.map(()=>`100% ${n}px`).join(", "),E=4,S=s.length*h-i;return{backgroundImage:f,backgroundPosition:j,backgroundSize:y,paddingBottom:`${E+S}px`}},[s]),u=["segment","relative","inline-block","rounded-md","px-2","cursor-pointer","transition-transform","duration-200","hover:-translate-y-0.5","leading-loose",a.showColorCoding?H(p):"bg-surface-soft",s&&s.length>0?"grammar-pattern":""].filter(Boolean).join(" "),o={paddingTop:a.showPitchAccent?"18px":"0.25rem",paddingBottom:"0.25rem",...m};return e.jsxs("span",{className:u,style:o,onClick:d,children:[e.jsx(M,{reading:l,pitchAccent:b}),e.jsx("div",{children:e.jsx(N,{base:x,reading:l})})]})},V=({pattern:t,onNoteClick:a,isFocused:r})=>{const{isLoading:c,error:x,data:l,execute:p}=$(),[b,s]=g.useState(!1),d=o=>{o.stopPropagation(),l?s(!b):(p(t.pattern_name),s(!0))},m=(t.constituent_indices||[]).map(o=>{const n=t.fullAnalysis.analysis[o];return n?n.japanese_segment:null}).filter(Boolean).join(""),u={pattern_name:t.pattern_name,explanation:t.explanation,original_sentence:t.fullAnalysis.original_japanese_sentence,constituent_text:m};return e.jsxs("li",{className:`flex gap-4 p-4 rounded-lg bg-surface-subtle cursor-pointer transition-all duration-200 ${r?"is-focused ring-2 ring-focus-ring bg-surface-soft":""}`,"data-pattern-id":t.idClass,onClick:()=>a(t),children:[e.jsx("span",{className:"flex-shrink-0 w-1.5 rounded-full",style:{backgroundColor:t.color}}),e.jsxs("div",{className:"flex-grow",children:[e.jsx("strong",{className:"font-semibold text-accent",children:t.pattern_name}),e.jsx("p",{className:"text-sm text-text-muted mt-1",children:t.explanation}),e.jsxs("div",{className:"mt-3 flex items-center gap-2 flex-wrap",children:[e.jsxs("button",{className:"show-examples-button text-xs font-semibold px-2 py-1 rounded-md border border-accent text-accent hover:bg-accent hover:text-primary-text transition inline-flex items-center gap-2 disabled:opacity-50",onClick:d,disabled:c,children:[c?e.jsx("i",{className:"bi bi-arrow-repeat text-base animate-spin"}):e.jsx("i",{className:"bi bi-card-list text-base"}),e.jsx("span",{className:"button-text",children:b&&l?"Hide":"Examples"})]}),e.jsx(_,{itemType:"grammar",itemContent:u})]}),b&&e.jsxs("div",{className:"examples-container mt-4 pt-4 border-t border-dashed border-border-subtle",children:[x&&e.jsx("p",{className:"text-xs text-destructive-subtle-text",children:x.message}),l&&e.jsx("dl",{className:"flex flex-col gap-4",children:l.map((o,n)=>e.jsxs(P.Fragment,{children:[e.jsx("dt",{children:e.jsx("span",{className:"text-lg font-jp",children:e.jsx(N,{base:o.japanese,reading:o.reading})})}),e.jsx("dd",{className:"text-sm text-text-muted -mt-1",children:o.english})]},n))})]})]})]})},G=()=>e.jsxs("div",{className:"mt-6 p-4 border-t border-border-subtle text-center",children:[e.jsx("h4",{className:"text-xs font-bold uppercase text-text-muted tracking-wider mb-3",children:"Hotkeys"}),e.jsxs("div",{className:"flex flex-wrap justify-center items-center gap-x-4 gap-y-2 text-xs text-text-secondary",children:[e.jsxs("span",{children:[e.jsx("kbd",{className:"font-sans font-semibold p-1 px-1.5 rounded bg-surface border border-border-subtle shadow-sm",children:"F"})," Furigana"]}),e.jsxs("span",{children:[e.jsx("kbd",{className:"font-sans font-semibold p-1 px-1.5 rounded bg-surface border border-border-subtle shadow-sm",children:"C"})," Colors"]}),e.jsxs("span",{children:[e.jsx("kbd",{className:"font-sans font-semibold p-1 px-1.5 rounded bg-surface border border-border-subtle shadow-sm",children:"T"})," Translate"]}),e.jsxs("span",{children:[e.jsx("kbd",{className:"font-sans font-semibold p-1 px-1.5 rounded bg-surface border border-border-subtle shadow-sm",children:"S"})," Speak"]}),e.jsx("div",{className:"w-px h-4 bg-border mx-2 self-center"}),e.jsxs("span",{children:[e.jsx("kbd",{className:"font-sans font-semibold p-1 px-1.5 rounded bg-surface border border-border-subtle shadow-sm",children:"J"}),"/",e.jsx("kbd",{className:"font-sans font-semibold p-1 px-1.5 rounded bg-surface border border-border-subtle shadow-sm",children:"K"})," Nav"]}),e.jsxs("span",{children:[e.jsx("kbd",{className:"font-sans font-semibold p-1 px-1.5 rounded bg-surface border border-border-subtle shadow-sm",children:"E"})," Examples"]}),e.jsxs("span",{children:[e.jsx("kbd",{className:"font-sans font-semibold p-1 px-1.5 rounded bg-surface border border-border-subtle shadow-sm",children:"Esc"})," Deselect"]})]})]});function K({analysis:t,onReanalyze:a,availableQuizText:r,onStartQuiz:c,isQuizLoading:x}){const[l,p]=g.useState(null),[b,s]=g.useState(!1),{state:d}=w(),m=g.useMemo(()=>{if(!t.grammar_patterns)return t.analysis.map(n=>({...n,patterns:[]}));const o=new Map;return t.grammar_patterns.forEach((n,i)=>{var j;const h=k(i,d.theme),f=`pattern-dynamic-${i}`;(j=n.constituent_indices)==null||j.forEach(y=>{o.has(y)||o.set(y,[]),o.get(y).push({...n,idClass:f,color:h})})}),t.analysis.map((n,i)=>({...n,patterns:o.get(i)||[]}))},[t,d.theme]),u=o=>{p(n=>(n==null?void 0:n.idClass)===o.idClass?null:o)};return e.jsxs("div",{className:"analysis-view-container animate-fade-in max-w-4xl mx-auto w-full",children:[e.jsxs("div",{id:"analysis-header",className:"sticky top-0 z-20 bg-surface-soft rounded-lg transition-colors duration-300 p-4",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsx("div",{className:"flex-grow flex flex-wrap items-start gap-x-1.5 gap-y-1 text-2xl max-h-[50vh] overflow-y-auto no-scrollbar",children:m.map((o,n)=>e.jsx("div",{className:`transition-opacity duration-300 ${l&&!o.patterns.some(i=>i.idClass===l.idClass)?"opacity-30":"opacity-100"}`,children:e.jsx(F,{segment:o})},n))}),e.jsxs("div",{className:"flex-shrink-0 flex flex-col items-center gap-2",children:[e.jsx(z,{text:t.original_japanese_sentence,title:"Read sentence (S)"}),e.jsx("button",{onClick:a,title:"Force re-analysis",className:"btn-ghost p-1 text-text-muted hover:text-text-primary",children:e.jsx("i",{className:"bi bi-arrow-clockwise text-base"})}),e.jsx("button",{id:"toggle-translation-button",onClick:()=>s(o=>!o),title:"Toggle translation (T)",className:"btn-ghost p-1 text-text-muted hover:text-text-primary",children:e.jsx("i",{className:"bi bi-translate text-base"})}),r&&e.jsx("div",{className:"pt-2 mt-2 border-t border-border-subtle w-full flex justify-center",children:e.jsx("button",{onClick:c,title:x?"Generating Quiz...":"Test Comprehension",className:"btn-ghost p-1 text-accent hover:text-accent/80 transition-all scale-110 hover:scale-125 disabled:cursor-wait disabled:opacity-70",disabled:x,children:x?e.jsx("i",{className:"bi bi-arrow-repeat text-xl animate-spin"}):e.jsx("i",{className:"bi bi-mortarboard-fill text-xl"})})})]})]}),b&&e.jsx("div",{className:"translation-text-container mt-4 pt-4 border-t border-dashed border-border-subtle",children:e.jsx("p",{className:"text-text-primary text-base",children:t.english_translation})})]}),e.jsx("div",{className:"p-4 space-y-4",children:t.grammar_patterns&&t.grammar_patterns.length>0&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold uppercase text-text-muted mb-3 tracking-wider",children:"Grammar & Phrases"}),e.jsx("ul",{className:"space-y-3",children:t.grammar_patterns.map((o,n)=>{const i=k(n,d.theme),h=`pattern-dynamic-${n}`,f={...o,idClass:h,color:i,fullAnalysis:t};return e.jsx(V,{pattern:f,onNoteClick:u,isFocused:(l==null?void 0:l.idClass)===h},n)})})]})}),e.jsx(G,{})]})}const Y=({sentence:t,isLoading:a=!0})=>e.jsxs("div",{className:"relative p-4 bg-surface-soft rounded-lg min-h-36 animate-fade-in",children:[e.jsx("div",{className:"flex flex-wrap items-start gap-x-1.5 gap-y-1 text-2xl pr-8",children:e.jsx("p",{className:`text-2xl text-text-muted font-japanese transition-opacity duration-500 ${a?"opacity-50":"opacity-100"}`,children:t})}),a&&e.jsx("div",{className:"absolute top-4 right-4 flex items-center gap-2",children:e.jsx("i",{className:"bi bi-arrow-repeat text-lg text-text-muted animate-spin",role:"status","aria-label":"Loading analysis"})})]});export{K as A,Y as a,J as u};
